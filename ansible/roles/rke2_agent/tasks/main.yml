---
- name: Ensure RKE2 config directory exists
  ansible.builtin.file:
    path: "{{ rke2_config_dir }}"
    state: directory
    mode: "0755"

- name: Render RKE2 agent config
  ansible.builtin.template:
    src: rke2-agent-config.yaml.j2
    dest: "{{ rke2_config_dir }}/config.yaml"
    mode: "0600"

- name: Install RKE2 agent binaries
  ansible.builtin.shell: |
    curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE=agent INSTALL_RKE2_VERSION={{ rke2_version }} sh -
  args:
    creates: /usr/local/bin/rke2

- name: Enable and start rke2-agent
  ansible.builtin.systemd:
    name: rke2-agent
    enabled: true
    state: started
