---
- name: Download Rancher import manifest URL
  ansible.builtin.get_url:
    url: "{{ rancher_import_manifest_url }}"
    dest: /tmp/rancher-import.yaml
    mode: "0644"
    validate_certs: "{{ rancher_validate_certs | default(true) }}"
  when: rancher_import_manifest_url | length > 0

- name: Register cluster in Rancher via downloaded import manifest
  ansible.builtin.command:
    cmd: "/var/lib/rancher/rke2/bin/kubectl apply -f /tmp/rancher-import.yaml"
  when: rancher_import_manifest_url | length > 0
  environment:
    KUBECONFIG: "{{ rke2_kubeconfig }}"

- name: Register cluster in Rancher via full registration command
  ansible.builtin.shell: "{{ rancher_registration_command }}"
  when:
    - rancher_import_manifest_url | length == 0
    - rancher_registration_command | length > 0
  environment:
    KUBECONFIG: "{{ rke2_kubeconfig }}"

- name: Warn when Rancher registration inputs are empty
  ansible.builtin.debug:
    msg: "Skipping Rancher registration. Set rancher_import_manifest_url or rancher_registration_command."
  when:
    - rancher_import_manifest_url | length == 0
    - rancher_registration_command | length == 0
