---
- name: Ensure RKE2 config directory exists
  ansible.builtin.file:
    path: "{{ rke2_config_dir }}"
    state: directory
    mode: "0755"

- name: Render RKE2 server config
  ansible.builtin.template:
    src: rke2-server-config.yaml.j2
    dest: "{{ rke2_config_dir }}/config.yaml"
    mode: "0600"

- name: Install RKE2 server binaries
  ansible.builtin.shell: |
    curl -sfL https://get.rke2.io | INSTALL_RKE2_VERSION={{ rke2_version }} sh -
  args:
    creates: /usr/local/bin/rke2

- name: Enable and start rke2-server
  ansible.builtin.systemd:
    name: rke2-server
    enabled: true
    state: started

- name: Wait for kubeconfig to be created (bootstrap server only)
  ansible.builtin.wait_for:
    path: "{{ rke2_kubeconfig }}"
    timeout: 300
  when: inventory_hostname in groups['k8s_cp_bootstrap']
